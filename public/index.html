<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Blockly Java 테스트</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <!-- JavaScript Generator 대신 JavaGenerator를 직접 로드한 상태라고 가정 -->
    <script src="/java_compressed.js"></script> <!-- 너가 만든 Java generator js 빌드 결과 -->
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #blocklyDiv {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>

<div id="blocklyDiv"></div>

<script>
    // 🧱 Toolbox (스크래치 스타일)
    const toolbox = {
        "kind": "categoryToolbox",
        "contents": [
            {
                "kind": "category",
                "name": "제어",
                "categorystyle": "loop_category",
                "contents": [
                    {"kind": "block", "type": "controls_repeat_ext"},
                    {"kind": "block", "type": "controls_whileUntil"}
                ]
            },
            {
                "kind": "category",
                "name": "수학",
                "categorystyle": "math_category",
                "contents": [
                    {"kind": "block", "type": "math_number"},
                    {"kind": "block", "type": "math_arithmetic"}
                ]
            },
            {
                "kind": "category",
                "name": "변수",
                "custom": "VARIABLE"
            }
        ]
    };

    // 🧱 자바 코드 테스트용 블럭(XML)
    const testXml = `
  <xml xmlns="https://developers.google.com/blockly/xml">
    <block type="math_number" x="40" y="40">
      <field name="NUM">99</field>
    </block>
    <block type="controls_repeat_ext" x="40" y="140">
      <value name="TIMES">
        <shadow type="math_number">
          <field name="NUM">3</field>
        </shadow>
      </value>
      <statement name="DO">
        <block type="math_change">
          <field name="VAR">i</field>
          <value name="DELTA">
            <shadow type="math_number">
              <field name="NUM">1</field>
            </shadow>
          </value>
        </block>
      </statement>
    </block>
  </xml>
  `;

    <!-- 1. Blockly core (이미 있다면 생략 가능) -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>

<!-- 2. 네가 만든 java_compressed.js (여기에 javaGenerator가 있음) -->
<script src="/blockly/java_compressed.js"></script>

<!-- 3. 이제 여기서 인스턴스 주입 가능 -->
<script>
    Blockly.Java = javaGenerator;
</script>

    const workspace = Blockly.inject('blocklyDiv', {
        toolbox: toolbox,
        scrollbars: true,
        trashcan: true
    });

    // 블럭 삽입
    const xml = Blockly.Xml.textToDom(testXml);
    Blockly.Xml.domToWorkspace(xml, workspace);

    // ✅ Flutter 호출용 함수
    function getGeneratedCode() {
        const code = Blockly.Java.workspaceToCode(workspace);
        if (window.FlutterChannel) {
            window.FlutterChannel.postMessage(code);
        }
        return code;
    }

    // ✅ Flutter → JS 호출 테스트용 (콘솔에서도 가능)
    window.getGeneratedCode = getGeneratedCode;

</script>

</body>
</html>
